Next we prepare the pronunciation dictionary. 
This consists of a directory \verb!data/local/dict!
containing all the filew described in this section.
In the \verb!iban! example the files described in this section
are created by the script \verb!local/prepare_dict.sh!.

First one prepares a file \verb!lexicon.txt! specifying
the pronunciations of some subset
of the words found in \verb!data/train/text!.
Naturally one is most interested in pronunciations
of the most common words, so it would be natural
to first order all the words of \verb!data/train/text! by
their frequencies, and then select, say, the 10,000 most common words
to be included in \verb!lexicon.txt!.
Note that the lexicon should {\em not} explicitly contain words
from \verb!data/test/text!. This affords the opportunity
to invoke another mechanism during testing,
namely the {\em unknown model}, which will be used to determine
the pronounciations of out-of-vocabulary words.

Each line of \verb!lexicon.txt! contains a word, followed by a space or tab,
followed by a sequence of phones, represented by tokens taken from a fixed
pronunciation alphabet.
The choice of this alphabet is not imposed by \textsf{Kaldi}, provided
that each phone is transcribed consistantly every time it appears
in a word.
For example, the first ten lines of \verb!lexicon.txt! are shown
below, from \verb!iban! on the left, and from \verb!wsj! on the right.

\begin{multicols}{2}
\begin{verbatim}
<sil>   SIL
<UNK>   SIL
ke      k @
nya     NJ a KK
iya     i j a
ba      b a KK
dua     d u w a
sida    s i d a KK
puluh   p u l u @ h
raban   r a b a n
\end{verbatim}
\begin{verbatim}
A42128  EY1 F AO1 R T UW1 W AH1 N T UW1 EY1 T
AAA  T R IH2 P AH0 L EY1
AABERG  AA1 B ER0 G
AACHEN  AA1 K AH0 N
AACHENER  AA1 K AH0 N ER0
A  AH0
AAKER  AA1 K ER0
AALSETH  AA1 L S EH0 TH
AAMODT  AA1 M AH0 T
AANCOR  AA1 N K AO2 R
\end{verbatim}
\end{multicols}

In the case of \verb!wsj! the pronunciations were extracted
from a dictionary that \verb!run.sh! downloaded from \verb!cmu.edu!.
In the case of \verb!iban! the pronunciations were provided
in the dataset. Another choice is to compose \verb!lexicon.txt!
by hand in case a pronunciation dictionary is unavailable.
Still another choice is to simply use the sequence of
letters of each word as a surrogate for its pronunciation.
This works well for {\em phonetic} languages
such as Spanish, since each letter is usually
pronounced in the same way.

Note also that \verb!lexicon.txt! from \verb!iban! also contains
entries for two special phones, \verb!<sil>! and \verb!<UNK>!,
both having pronunciation \verb!SIL!.
These entries cause \textsf{Kaldi} to invoke special models,
namely the {\em silence model}, which modeles the acoustic properties
of the speaker's physical environment, and the unknown
model mentioned above.

Each of the tokens representing phones in \verb!lexicon.txt!
is expected to be listed in one the files
\verb!nonsilence_phones.txt!,
\verb!silence_phones.txt!, or
\verb!optional_silence.txt!.
In this way the phonetic transcriptions can be mapped to integer
sequences, the integers referring to line numbers in these files.
\verb!silence_phones! specify which phones should invoke the silence model.
Multiple types of silence could be modeled by introducing
special symbols in the file \verb!optional_silence!.
However, in the \verb!iban! example both
\verb!silence_phones.txt! and \verb!optional_silence.txt!
contain only \verb!SIL!.

The pronounciation of a given phone varies widely,
even by the same speaker. \textsf{Kaldi} handles this by creating
multiple HMMs for each phone, and choosing among them with the help
of a decision tree. Starting at the root of the tree, one traverses
the tree, choosing among branches according to responses to specific
qustions about the usage of the phone, arriving finally at a leaf
labeled by an HMM.
The questions labeling branch points
in the tree are listed in the file \verb!extra_quesitons!.

One frequent source of phonemic variation is the context of a phone.
In case the phones are context-dependent (as in the \verb!iban! example)
this file would specify branching decisions based on the context
of the phone, as implemented by the postfixes
\verb!_B!, \verb!_I!, \verb!_E!, and \verb!_S! mentioned above.
In the case of a tonal language the file could be used to pose
questions about rising or falling tone.

The file \verb!lexiconp.txt! is used to allow a word to have multiple
pronounciations. After counting occurances of each variation
in the training corpus, the file specifies its relative
frequency along with its pronounciation.
It also specifies phonemic context, by appending symbols
\verb!_B! (for word-initial),
\verb!_I! (for word-internal),
\verb!_E! (for word-final),
\verb!_S! (for standalone),
to the phones. This mechanism will be described below.

Only specifying the pronounciation of each word
would make it impossible to distinguish among homophones, such
as {\em two} and {\em too}. \textsf{Kaldi} handles this ambiguity
using disambugiation symbols.
Namely, it lists each word in \verb!lexiconp_disambig.txt!,
along with the sequence of phones specifiying its pronounciation,
now decorated with context dependence postfixes
\verb!_B!, \verb!_I!, \verb!_E!, and \verb!_S!,
and with homophones distinguished by appending extra phones
\verb!#1!, \verb!#2!, etc to the pronounciation strings when needed.
The first few lines of this file are shown below
\begin{verbatim}
<sil> 1.0 SIL_S #1
<UNK> 1.0 SIL_S #2
ke  1.0 k_B @_E
nya 1.0 NJ_B a_I KK_E
iya 1.0 i_B j_I a_E
ba  1.0 b_B a_I KK_E #1
dua 1.0 d_B u_I w_I a_E
sida  1.0 s_B i_I d_I a_I KK_E
\end{verbatim}
Later in the same file one finds the line
\begin{verbatim}
bak 1.0 b_B a_I KK_E #2
\end{verbatim}
telling us that the words {\em ba} and {\em bak}
have the same pronounciation.
Finally the file specifies the proporition of the time
each instance of a homophone occurs, although these numbers
have been modified so that the minimum is scaled to \verb!1.0!, I think.

\verb!phones.txt! and \verb!words.txt! map all the possible phones
and words into integers. All references to phones and words
apply the mapping given by these files for computational efficiency.

The context-dependent HMMs for phones are specified in \verb!data/lang/topo!
